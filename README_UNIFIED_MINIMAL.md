# Unified Pipeline (Refactored)

This is the canonical README for the refactored, modular tissue analysis pipeline. The primary entrypoint is `unified_pipeline_refactored.py`, which uses the `unified_pipeline/` package.

All previous READMEs and standalone scripts (`unified_pipeline.py`, `simple_main.py`, `myvalis/valis_cli.py`) are deprecated.

## Overview

The goal of this pipeline is to align tissue cores between two whole-slide images (WSI)â€”typically a stain image (e.g., H&E) and a DAPI fluorescence image. It performs the following key functions:

1.  **Segmentation**: Identifies and crops individual tissue cores from both the stain and DAPI images.
2.  **Registration**: Aligns each DAPI core to its corresponding stain core using VALIS.
3.  **Transformation**: Maps cell centroid coordinates from the DAPI image to the stain image's coordinate space.

The primary inputs are the two WSIs and a TSV file with cell centroid data. The final output is a single TSV file containing the transformed coordinates, ready for downstream analysis.

## Requirements

- Apptainer/Singularity
- NVIDIA GPU and compatible drivers for `--nv` flag

## Quick Start

### 1. Build the Container

There are three ways to build the container:

#### Option A: Local Build with Fakeroot (Recommended)
Build using fakeroot:
```bash
apptainer build --fakeroot unified_pipeline_gpu.sif unified_pipeline_gpu.def
```
#### Option B: Use Prebuilt sif
Use Prebuilt sif:
wget example/unified_pipeline.sif

### 2. Run the Pipeline

Execute the pipeline using the refactored script inside the container. 

```bash
apptainer exec \
  --nv \
  --env CUDA_VISIBLE_DEVICES=0 \
  --bind "$PWD:/workspace" \
  unified_pipeline_gpu.sif \
  python unified_pipeline_refactored.py --config /workspace/inputs/config.yaml
```

- **`--bind "$PWD:/workspace"`**: Mounts the current project directory into the container. Assumes you are at the repository root.
- **`--nv`**: Enables GPU support.
- **`--config`**: Specifies the path to the configuration file (Default: `inputs/config.yaml`) *inside the container*.

## Configuration (`inputs/config.yaml`)

The pipeline's behavior is controlled by a single YAML file. Paths for `inputs` and `outputs` are relative to the directory containing the config file.

**Key Sections:**

- **`inputs`**: Paths to input data.
  - `dapi_image`: Full-resolution DAPI image.
  - `stain_image`: Full-resolution stain image (e.g., H&E).
  - `pcf_csv`, `visium_csv`, `centroids_tsv`: Additional data files for processing.

- **`outputs`**: Defines output locations.
  - `base_dir`: Directory for processed images and segmentation results (e.g., `../cellSeg`).
  - `valis_workdir`: Directory for VALIS registration artifacts (e.g., `../valis_work`).
  - `final_output`: Path for the final transformed data file (e.g., `../outputs/transformed.tsv`).

- **`global`**: Global parameters for the pipeline.
  - `microns_per_pixel`, `cores_per_row`, `expected_cores`, `flip_axis`, `verbose`.

- **`segmentation`**: Parameters for core segmentation, with subsections for `dapi` and `stain`.
  - `downsample_factor`, `cellpose` parameters, `preprocessing` options, and `cropping` settings.

- **`valis`**: Parameters for VALIS registration.
  - `preprocessing.scale_factor`, `superglue` settings, `registration` timeouts, and artifact generation.

- **`coordinates`**: Defines column names for coordinate data and other identifiers.
  - `x_column`, `y_column`, `enforce_canonical_ids`.

## Directory Structure

The pipeline uses a canonical directory structure for inputs and outputs:

- `inputs/`: Source images, data files, and `config.yaml`.
- `cellSeg/`: Processed images and segmentation results for each modality.
- `valis_work/`: Per-core registration artifacts generated by VALIS.
- `outputs/`: Final aggregated and transformed data files.

## Modular Architecture

The `unified_pipeline/` package is organized by function:

- `config/`: Configuration loading and validation.
- `segmentation/`: Tissue core segmentation logic.
- `registration/`: VALIS alignment and registration.
- `core/`: Core processing utilities.
- `pipeline.py`: Main pipeline orchestration.
- `cli.py`: Command-line interface logic.
